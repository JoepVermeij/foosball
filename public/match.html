<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Foosball Match</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Record New Match</h1>
            <div class="space-x-4">
                <a href="/" class="text-blue-500 hover:text-blue-600">Leaderboard</a>
                <a href="/users" class="text-blue-500 hover:text-blue-600">Manage Players</a>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <form id="matchForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Team 1 -->
                    <div class="space-y-4">
                        <h2 class="text-xl font-semibold text-gray-700">Team 1</h2>
                        <div>
                            <label for="team1defender" class="block text-sm font-medium text-gray-700">Defender</label>
                            <select id="team1defender" name="team1defender" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select a defender</option>
                            </select>
                        </div>
                        <div>
                            <label for="team1attacker" class="block text-sm font-medium text-gray-700">Attacker</label>
                            <select id="team1attacker" name="team1attacker" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select an attacker</option>
                            </select>
                        </div>
                    </div>

                    <!-- Team 2 -->
                    <div class="space-y-4">
                        <h2 class="text-xl font-semibold text-gray-700">Team 2</h2>
                        <div>
                            <label for="team2defender" class="block text-sm font-medium text-gray-700">Defender</label>
                            <select id="team2defender" name="team2defender" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select a defender</option>
                            </select>
                        </div>
                        <div>
                            <label for="team2attacker" class="block text-sm font-medium text-gray-700">Attacker</label>
                            <select id="team2attacker" name="team2attacker" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <option value="">Select an attacker</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div>
                    <label for="winner" class="block text-sm font-medium text-gray-700">Winning Team</label>
                    <select id="winner" name="winner" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="1">Team 1</option>
                        <option value="2">Team 2</option>
                    </select>
                </div>

                <div class="flex justify-end">
                    <button type="submit"
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                        Submit Match
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Load players by position
        async function loadPlayersByPosition(position) {
            try {
                const url = position === 'all' ? '/api/players' : `/api/players/${position}`;
                const response = await fetch(url);
                const players = await response.json();
                
                // Sort players by name for easier selection
                players.sort((a, b) => a.name.localeCompare(b.name));
                return players;
            } catch (error) {
                console.error(`Error loading ${position} players:`, error);
                return [];
            }
        }
        
        // Populate a specific dropdown with players
        function populateDropdown(dropdownId, players, position) {
            const dropdown = document.getElementById(dropdownId);
            // Keep the first option (select a player)
            const firstOption = dropdown.options[0];
            dropdown.innerHTML = '';
            dropdown.appendChild(firstOption);
            
            // Add all players
            players.forEach(player => {
                // Only include players that match the position or have 'any' position
                if (position === 'all' || player.position === position || player.position === 'any') {
                    const option = document.createElement('option');
                    option.value = player.name;
                    option.textContent = player.name;
                    dropdown.appendChild(option);
                }
            });
        }
        
        // Initialize all dropdowns
        async function loadAllDropdowns() {
            try {
                const defenders = await loadPlayersByPosition('defender');
                const attackers = await loadPlayersByPosition('attacker');
                const allPlayers = await loadPlayersByPosition('all');
                
                // Populate defender dropdowns with defenders and players with 'any' position
                populateDropdown('team1defender', defenders.concat(allPlayers.filter(p => p.position === 'any')), 'defender');
                populateDropdown('team2defender', defenders.concat(allPlayers.filter(p => p.position === 'any')), 'defender');
                
                // Populate attacker dropdowns with attackers and players with 'any' position
                populateDropdown('team1attacker', attackers.concat(allPlayers.filter(p => p.position === 'any')), 'attacker');
                populateDropdown('team2attacker', attackers.concat(allPlayers.filter(p => p.position === 'any')), 'attacker');
            } catch (error) {
                console.error('Error loading players for dropdowns:', error);
                alert('Error loading player lists. Please try again later.');
            }
        }

        document.getElementById('matchForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Get selected values from dropdowns
            const team1Defender = document.getElementById('team1defender').value;
            const team1Attacker = document.getElementById('team1attacker').value;
            const team2Defender = document.getElementById('team2defender').value;
            const team2Attacker = document.getElementById('team2attacker').value;
            
            // Validate all players are selected and no duplicates
            const allPlayers = [team1Defender, team1Attacker, team2Defender, team2Attacker];
            const uniquePlayers = new Set(allPlayers);
            
            if (uniquePlayers.size !== 4) {
                alert('Please select different players for each position');
                return;
            }

            const matchData = {
                team1: {
                    defender: team1Defender,
                    attacker: team1Attacker
                },
                team2: {
                    defender: team2Defender,
                    attacker: team2Attacker
                },
                winner: parseInt(document.getElementById('winner').value)
            };

            try {
                const response = await fetch('/api/match', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(matchData)
                });

                if (response.ok) {
                    alert('Match recorded successfully!');
                    window.location.href = '/';
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to record match');
                }
            } catch (error) {
                console.error('Error:', error);
                alert(error.message || 'Error recording match. Please try again.');
            }
        });

        // Load players when page loads
        loadAllDropdowns();
    </script>
</body>
</html> 